---
- name: "check if koala is running"
  systemd:
    name: "koala.service"
    state: "started"
  check_mode: true
  register: "koala_running"
  listen: "restart koala"

- name: "restart oauth2_proxy"
  systemd:
    name: "oauth2_proxy"
    daemon_reload: true
    state: "restarted"
  listen: "restart oauth2_proxy"

- name: "restart koala service"
  systemd:
    name: "koala"
    daemon_reload: true
    state: "restarted"
  when: "koala_running is not changed"
  listen: "restart koala"

- name: "restart fail2ban"
  systemd:
    name: "fail2ban"
    daemon_reload: true
    state: "restarted"

- name: "restart redis"
  systemd:
    name: "redis-server"
    daemon_reload: true
    state: "restarted"

- name: "restart mariadb"
  systemd:
    name: "mysql"
    daemon_reload: true
    state: "restarted"

- name: "test nginx configuration"
  command: "nginx -t"
  register: "nginx_reload"
  listen:
    - "reload nginx"
    - "restart nginx"

- name: "reload nginx service"
  systemd:
    name: "nginx"
    daemon_reload: true
    state: "reloaded"
  when: "nginx_reload is success"
  listen: "reload nginx"

- name: "restart nginx service"
  systemd:
    name: "nginx"
    daemon_reload: true
    state: "restarted"
  when: "nginx_reload is success"
  listen: "restart nginx"

- name: "reload php"
  systemd:
    name: "php7.2-fpm"
    daemon_reload: true
    state: "reloaded"

- name: "systemctl daemon-reload"
  systemd:
    daemon_reload: true

- name: "issue reboot command"
  shell: "sleep 2 && /sbin/reboot"
  async: 60
  poll: 0
  ignore_errors: true
  listen: "reboot server"

- name: "wait for server to finish rebooting"
  wait_for_connection:
    delay: 20
  listen: "reboot server"

- name: "restart aas"
  systemd:
    unit: "aas.service"
    daemon_reload: true
    state: "restarted"
