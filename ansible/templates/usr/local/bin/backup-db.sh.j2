#!/usr/bin/env bash
# {{ ansible_managed }}

# Unofficial Bash strict mode
set -Efuo pipefail
IFS=$'\n\t'

DB_USER="root"
DB_PASS="{{ lookup('file', 'credentials/mysql/root') }}"
TMPDIR="/tmp"
FILE="databases-$(date +'%Y-%m-%d').sql.gz"
HASH="sha256" # Choose from md5/sha1/sha224/sha256/sha384/sha512
S3PATH="s3://sticky-automatic-backups/websites/databases"

cleanup() {
    # Ensure files are deleted, in case script crashes
    rm -rf "${TMPDIR}/${FILE}{,.${HASH}}"
}

if [[ "${BASH_SOURCE[0]}" = "$0" ]]; then
    trap cleanup EXIT

    mysqldump --user="${DB_USER}" --password="${DB_PASS}" --all-databases | gzip -9 > "${TMPDIR}/${FILE}"
    ${HASH}sum "${TMPDIR}/$FILE" > "${TMPDIR}/${FILE}.${HASH}"
    aws s3 cp "${TMPDIR}/" "${S3PATH}/" --recursive
    rm "${TMPDIR}/${FILE}"
    aws s3 cp "${S3PATH}/${FILE}" "${TMPDIR}/${FILE}"
    ${HASH}sum --check "${TMPDIR}/${FILE}.${HASH}"
fi
