---
- name: "clone fancy-index and copy theme files"
  block:
  - name: "clone repo"
    ansible.builtin.git:
      repo: "https://github.com/svsticky/fancy-index.git"
      dest: "/var/www/fancy-index"
    diff: false

  - name: "install and compile fancy-index"
    ansible.builtin.shell: |
      source {{ nvm.script }}
      nvm use
      ./build.sh
    args:
      chdir: "/var/www/fancy-index"
      executable: "/bin/bash"

- name: "perform logic for public.svsticky.nl and files.svsticky.nl"
  block:
  - name: "create site root Fancy Index & theme dir"
    ansible.builtin.file:
      path: "/var/www/{{ item }}.{{ canonical_hostname }}"
      owner: "www-data"
      group: "adm"
      mode: "2775"
      state: "directory"

  - name: "create site root Fancy Index & theme dir"
    ansible.builtin.file:
      path: "/var/www/{{ item }}.{{ canonical_hostname }}/theme"
      owner: "www-data"
      group: "www-data"
      state: "directory"   

  - name: "copy Fancy Index theme"
    ansible.builtin.copy:
      src: "/var/www/fancy-index/theme"
      dest: "/var/www/{{ item }}.{{ canonical_hostname }}/theme"
      owner: "www-data"
      group: "www-data"

  - name: "copy NGiNX site config Fancy Index"
    ansible.builtin.template:
      src: "{{ item }}.conf.j2"
      dest: "/etc/nginx/sites-available/{{ item }}.{{ canonical_hostname }}.conf"
    notify: "reload nginx"

  - name: "enable NGiNX site config Fancy Index"
    ansible.builtin.file:
      src: "/etc/nginx/sites-available/{{ filename }}"
      path: "/etc/nginx/sites-enabled/{{ filename }}"
      state: "link"
    vars:
      filename: "{{ item }}.{{ canonical_hostname }}.conf"
    notify: "reload nginx"
  loop:
    - files
    - public
