---
- name: "install aws cli tool"
  apt:
    pkg: awscli
    state: present

- name: "ensure aws cli configuration folders are present"
  file:
    path: "{{ item.path }}{{ item.name }}/.aws"
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    state: directory
  with_items:
    - { path: '/home/', name: 'ansible' }
    - { path: '/', name: 'root' }

- name: "ensure aws cli configuration is present"
  template:
    src: "templates/home/ansible/.aws/config.j2"
    dest: "/home/ansible/.aws/config"
    owner: ansible
    group: ansible

- name: "ensure aws cli configuration is linked for root user"
  file:
    src: "/home/ansible/.aws/config"
    path: "/root/.aws/config"
    state: link

- name: "ensure aws cli scripts are present and executable"
  template:
    src: "templates/home/ansible/.aws/{{ item }}.j2"
    dest: "/home/ansible/.aws/{{ item }}"
    mode: u+x
    owner: ansible
    group: ansible
  with_items:
    - admins-backup.sh
    - db-backup.sh
    - websites-backup.sh

- name: "ensure backup services and timers are present"
  template:
    src: "templates/etc/systemd/system/{{ item }}.j2"
    dest: "/etc/systemd/system/{{ item }}"
  with_items:
    - admins-backup.service
    - admins-backup.timer
    - db-backup.service
    - db-backup.timer
    - websites-backup.service
    - websites-backup.timer
  notify:
    - systemctl daemon-reload

- name: "start and enable backup timers"
  service:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items:
    - admins-backup.timer
    - db-backup.timer
    - websites-backup.timer
