---
- name: "install netdata"
  apt:
    name: "netdata"
    state: "present"
  tags:
    - "monitoring"
    - "packages"

- name: "enable slack notifications for netdata's alarms"
  lineinfile:
    path: "/etc/netdata/health_alarm_notify.conf"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: "present"
  with_items:
    - regexp: "^SEND_SLACK="
      line: "SEND_SLACK=\"YES\""
    - regexp: "^SLACK_WEBHOOK_URL="
      line: "SLACK_WEBHOOK_URL=\"{{ slack_notifications.webhook_url }}\""
    - regexp: "^DEFAULT_RECIPIENT_SLACK="
      line:
        "DEFAULT_RECIPIENT_SLACK=\"{{ slack_notifications.default_channel }}\""
  register: "netdata_slack_notifications"

- name: "raise alert threshold for tcp listen drops"
  template:
    src: "templates/{{ path }}.j2"
    dest: "/{{ path }}"
    owner: "netdata"
    group: "netdata"
    mode: "0660"
  vars:
    path: "etc/netdata/health.d/tcp_listen.conf"
  register: "netdata_listen_drop_rules"

# netdata service doesn't implement reloading
- name: "restart netdata if config changed"
  service:
    name: "netdata"
    state: "restarted"
  when:
    "netdata_slack_notifications.changed or
    netdata_listen_drop_rules.changed"

- name: "copy nginx files for metrics site"
  template:
    src: "templates/{{ item.path }}.conf.j2"
    dest: "/{{ item.path }}.{{ canonical_hostname }}.conf"
    group: "{{ item.group | default(omit) }}"
    mode: "{{ item.mode | default(omit) }}"
  with_items:
    - path: "etc/nginx/sites-available/metrics"
    - path: "etc/nginx/htpasswd.d/metrics"
      group: "www-data"
      mode: "640"
  notify: "reload nginx"

- name: "enable nginx proxy config for metrics site"
  file:
    src: "/etc/nginx/sites-available/metrics.{{ canonical_hostname }}.conf"
    path: "/etc/nginx/sites-enabled/metrics.{{ canonical_hostname }}.conf"
    state: "link"
  tags:
    - "monitoring"
    - "nginx"
  notify: "reload nginx"
