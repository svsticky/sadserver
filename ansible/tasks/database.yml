---
# Contains application-agnostic database tasks
- block:
  - name: "ensure mariadb is installed and manageable"
    apt:
        name: "{{ item }}"
        state: "present"
    with_items:
        - "mariadb-server"
        - "python-mysqldb"
    tags:
        - "packages"

  - name: "ensure database is enabled and running"
    service:
        name: "mysql"
        enabled: true
        state: "started"
    tags:
        - "service"

  - name: "prepare db"
    command: "mysql -NBe '{{ item }}'"
    with_items:
      - "grant all privileges on *.* to `root`@`localhost` identified via unix_socket with grant option;"
      - "drop database test;"

  - name: "create website databases"
    command: "mysql -NBe 'create database if not exists {{ item.database }};'"
    with_items: "{{ websites }}"
    when: item.database is defined

  # TODO: cut permission scope?
  - name: "create website database users"
    command: "mysql -NBe 'grant all privileges on {{ item.database }}.* to `{{ item.database }}`@`localhost` identified via mysql_native_password with {{ item.db_pass_hash }};'"
    with_items: "{{ websites }}"
    when: (item.database is defined) and (item.db_pass_hash is defined)

  tags:
    - "database"
