---
- name: "create outline user"
  user:
    name: "outline"
    state: "present"
    shell: "/bin/false"
    system: true
    home: "/var/www/outline"
    password: "!"

- name: "create outline directory"
  file:
    path: "/var/www/outline/outline"
    state: "directory"
    owner: "outline"
    group: "outline"

- name: "clone Outline"
  become_user: "outline"
  git:
    repo: "https://github.com/svsticky/Sticky-Compendium.git"
    dest: "/var/www/outline/outline"
    version: "master"
  register: "_outline_checkout"

- name: "create environment file"
  template:
    src: "etc/outline/outline.env.j2"
    dest: "/etc/outline/outline.env"
    owner: "root"
    mode: "0600"
  register: "_outline_env_file"

- name: "do Yarn stuff"
  args:
    chdir: "/var/lib/outline/outline"
  become_user: "outline"
  block:
    - name: "install dependencies"
      command: "yarn install"

    - name: "build outline"
      command: "yarn build"

- name: "install Systemd service"
  template:
    src: "etc/systemd/system/outline.service.j2"
    dest: "/etc/systemd/system/outline.service"
    owner: "root"
    mode: "0644"
  register: "_outline_service_file"

- name: "restart outline if config changed"
  when: "_outline_checkout is changed
      or _outline_service_file is changed
      or _outline_env_file is changed"
  systemd:
    name: "outline.service"
    state: "restarted"
    daemon_reload: true

- name: "ensure outline service is started and enabled"
  systemd:
    name: "outline.service"
    state: "started"
    enabled: true
