---
- name: "create outline user"
  ansible.builtin.user:
    name: "outline"
    state: "present"
    shell: "/bin/false"
    system: true
    home: "/var/www/outline"
    password: "!"

- name: "create outline directory"
  ansible.builtin.file:
    path: "/var/www/outline/outline"
    state: "directory"
    owner: "outline"
    group: "outline"

- name: "do database setup"
  become_user: "postgres"
  block:
  - name: "ensure Postgres role exists"
    community.postgresql.postgresql_user:
      name: "outline"
      state: "present"

  - name: "ensure database exists"
    community.postgresql.postgresql_db:
      name: "outline"
      owner: "outline"
      state: "present"

- name: "ensure config directory exists"
  ansible.builtin.file:
    path: "/etc/outline"
    state: "directory"

- name: "create environment file"
  ansible.builtin.template:
    src: "outline.env.j2"
    dest: "/etc/outline/outline.env"
    owner: "root"
    mode: "0600"
  notify: "restart outline"

- name: "do Yarn stuff"
  become_user: "outline"
  block:
    - name: "clone repo"
      ansible.builtin.git:
        repo: "https://github.com/svsticky/Sticky-Compendium.git"
        dest: "/var/www/outline/outline"
        version: "main"
      register: "_outline_checkout"
      notify: "restart outline"

    - name: "install dependencies"
      when: "_outline_checkout is changed"
      ansible.builtin.command: "yarn install --frozen-lockfile"
      args:
        chdir: "/var/www/outline/outline"

    - name: "build outline"
      when: "_outline_checkout is changed"
      ansible.builtin.command: "yarn build"
      args:
        chdir: "/var/www/outline/outline"

- name: "install Systemd service"
  ansible.builtin.template:
    src: "outline.service.j2"
    dest: "/etc/systemd/system/outline.service"
    owner: "root"
    mode: "0644"
  notify: "restart outline"

- name: "ensure outline service is started and enabled"
  ansible.builtin.systemd:
    name: "outline.service"
    state: "started"
    enabled: true

- name: "install nginx config"
  ansible.builtin.template:
    src: "outline.conf.j2"
    dest: "/etc/nginx/sites-enabled/outline.conf"
  notify: "reload nginx"
