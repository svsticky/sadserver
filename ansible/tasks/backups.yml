---
- block:
  - block: # As root
    - name: "remove awscli package"
      apt:
        pkg: "awscli"
        state: "absent"

    - name: "install dependency"
      apt:
        pkg: "python3-venv"
        state: "present"

    - name: "create awscli virtualenv"
      shell: "python3 -m venv /opt/awscli"
      creates: "/opt/awscli"

    - name: "install awscli"
      shell: "source /opt/awscli/bin/activate; pip install awscli"

    - name: "place aws wrapper"
      template:
        src: "templates/usr/local/bin/aws"
        dest: "/usr/local/bin/aws"
        mode: "0755"
    become: true
    # End of as root

  - name: "ensure aws cli configuration folders are present"
    file:
      path: "{{ item.path }}/.aws"
      owner: "{{ item.owner }}"
      group: "{{ item.owner }}"
      state: "directory"
    with_items:
      - path: "/home/ansible"
        owner: "ansible"
      - path: "/root"
        owner: "root"

  - name: "ensure aws cli configuration is present"
    template:
      src: "templates/home/ansible/.aws/config.j2"
      dest: "/home/ansible/.aws/config"
    become: false

  - name: "ensure aws cli configuration is linked for root user"
    file:
      src: "/home/ansible/.aws/config"
      path: "/root/.aws/config"
      state: "link"

  - name: "ensure aws cli script is present, with correct permissions"
    template:
      src: "templates/{{ item }}.j2"
      dest: "/{{ item }}"
      mode: "0744"
    with_items:
      - "usr/local/bin/backup-to-s3.sh"

  - name: "ensure backup services and timers are present"
    template:
      src: "templates/etc/systemd/system/{{ item }}.j2"
      dest: "/etc/systemd/system/{{ item }}"
    with_items:
      - "backup-admins.service"
      - "backup-admins.timer"
      - "backup-databases.service"
      - "backup-databases.timer"
      - "backup-websites.service"
      - "backup-websites.timer"
      - "backup-fail@.service"
    notify:
      - "systemctl daemon-reload"

  - name: "start and enable backup timers in production"
    service:
      name: "{{ item }}"
      enabled: "{% if 'staging' in group_names %}false{% else %}true{% endif %}"
      state:
        "{% if 'staging' in group_names %}stopped{% else %}started{% endif %}"
    with_items:
      - "backup-admins.timer"
      - "backup-databases.timer"
      - "backup-websites.timer"

  tags: "backups"
