---
# Contains application-agnostic database tasks
- block:
  - name: "add apt key for postgresql"
    apt_key:
      url: "https://www.postgresql.org/media/keys/ACCC4CF8.asc"
      state: "present"
      id: "B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8"

  - name: "add postgresql apt repository"
    apt_repository:
      repo: "deb http://apt.postgresql.org/pub/repos/apt {{ ansible_lsb.codename }}-pgdg main"

  - name: "ensure postgresql is installed and manageable"
    apt:
      name:
        - "postgresql-13"
        - "python3-psycopg2"
    tags:
      - "packages"

  - name: "ensure koala user exists"
    postgresql_user:
      name: "koala"
    become_user: postgres

  - name: "ensure koala database exists"
    postgresql_db:
      name: "koala"
      owner: "koala"
    become_user: postgres

  - name: "ensure koala user exists"
    postgresql_user:
      db: "koala"
      name: "koala"
      priv: "ALL"
      role_attr_flags: CREATEDB,LOGIN
    become_user: postgres

  - name: "ensure dbeaver koala user exists"
    postgresql_user:
      db: "koala"
      name: "koala_manual"
      password: "{{ secret_koala_manual.password }}"
      priv: "CONNECT"
      role_attr_flags: "NOSUPERUSER"
    become_user: postgres

  - name: "ensure dbeaver koala user has the right privs"
    postgresql_privs:
      db: "koala"
      role: "koala_manual"
      objs: "ALL_IN_SCHEMA"
      privs: "SELECT"
    become_user: postgres

  - name: "remove mariadb apt repository"
    apt_repository:
      repo: "deb http://ams2.mirrors.digitalocean.com/mariadb/repo/10.5/ubuntu {{ ansible_lsb.codename }} main"
      state: "absent"

  - name: "remove mariadb package"
    apt:
      name:
        - "mariadb-server-10.5"
        - "python3-mysqldb"
      state: "absent"
    tags:
      - "packages"

  - name: "remove mariadb override"
    file:
      path: "/etc/systemd/system/mysql.service.d"
      state: "absent"

  - name: "remove extra configuration"
    file:
      path: "/etc/mysql/conf.d/mysqld.cnf"
      state: "absent"

  - name: "cleanup mysql databases"
    file:
      path: "/etc/mysql"
      state: "absent"
