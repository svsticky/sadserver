---
- name: "create committee group"
  group:
    name: "committee"
    state: "present"

- name: "create /var/www"
  file:
    path: "/var/www"
    mode: "o=rx"
    state: "directory"

# When users are deleted here, their home directory is not. Run
# ../playbooks/purge-old-users.yml for that.
- name: "create/delete human users"
  user:
    name: "{{ item.name }}"
    groups: "{% if item.admin %}sudo,adm,www-data{% else %}committee{% endif %}"
    shell: "/bin/bash"
    home: "/home/{{ item.name }}"
    move_home: true
    state: "{{ item.state }}"
  with_items:
    - "{{ users }}"
  loop_control:
    label: "{{ item.name }}"

- name: "add environment to bash prompt of human users"
  lineinfile:
    dest: "/home/{{ item.name }}/.bashrc"
    regexp: "^export PS1="
    line: "{{ bash_prompt }}"
  when: "item.state == 'present'"
  with_items:
    - "{{ users }}"
  loop_control:
    label: "{{ item.name }}"

- name: "add environment to bash prompt of root"
  lineinfile:
    dest: "/root/.bashrc"
    regexp: "^export PS1="
    line:
      "{{ bash_prompt | regex_replace('\\$ ', '# ') }}"

- name: "create/delete machine users"
  user:
    name: "{{ item.name }}"
    create_home: "{{ item.create_home | default(false) }}"
    home:
      "{{ ('/home/' + item.name) if (item.create_home is defined and
      item.create_home) else omit }}"
    move_home: true
    shell: "/usr/sbin/nologin"
    system: true
    state: "{{ item.state }}"
  with_items:
    - "{{ machine_users }}"
  loop_control:
    label: "{{ item.name }}"
